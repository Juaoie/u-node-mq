var w=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var P=(s,e)=>{for(var t in e)w(s,t,{get:e[t],enumerable:!0})},S=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of N(e))!R.call(s,o)&&o!==t&&w(s,o,{get:()=>e[o],enumerable:!(n=v(e,o))||n.enumerable});return s};var I=s=>S(w({},"__esModule",{value:!0}),s);var D=(s,e,t)=>new Promise((n,o)=>{var u=r=>{try{c(t.next(r))}catch(g){o(g)}},a=r=>{try{c(t.throw(r))}catch(g){o(g)}},c=r=>r.done?n(r.value):Promise.resolve(r.value).then(u,a);c((t=t.apply(s,e)).next())});var z={};P(z,{Consumer:()=>m,Exchange:()=>x,Logs:()=>i,News:()=>h,Queue:()=>p,createUnmq:()=>L,default:()=>M,extend:()=>q,isArray:()=>H,isBoolean:()=>B,isDate:()=>F,isFunction:()=>f,isMap:()=>j,isNumber:()=>U,isObject:()=>T,isPromise:()=>k,isSet:()=>A,isString:()=>O,isSymbol:()=>$,objectToString:()=>E,toTypeString:()=>b});module.exports=I(z);var l=class{static random(){return String(Math.round(Math.random()*1e10))}static getTimeFormat(e){let t=null;e?t=new Date(e):t=new Date;let n=t.getFullYear(),o=t.getMonth()+1,u=t.getDate(),a=t.getHours(),c=t.getMinutes(),r=n+"-";return o<10&&(r+="0"),r+=o+"-",u<10&&(r+="0"),r+=u+" ",a<10&&(r+="0"),r+=a+":",c<10&&(r+="0"),r+=c,r}};l.promiseSetTimeout=(e=0)=>new Promise(t=>setTimeout(t,e)),l.memorySize=e=>{let t=0,n;for(let o=0;o<e.length;o++)n=e.charCodeAt(o),n<127?t++:128<=n&&n<=2047?t+=2:2048<=n&&n<=65535?t+=3:t+=4;return t>=1024*1024?(t/(1024*1024)).toFixed(2)+"MB":t>=1024&&t<1024*1024?(t/1024).toFixed(2)+"KB":t+"B"};var i=class{static error(e){console.error(e)}static log(e){console.log(e)}};i.unmq=null;var x=class{constructor(e){this.id=l.random();this.routes=[];(e==null?void 0:e.routes)!==void 0&&(this.routes=e.routes),(e==null?void 0:e.repeater)!==void 0&&(this.repeater=e.repeater),(e==null?void 0:e.name)!==void 0&&(this.name=e.name)}getId(){return this.id}getRoutes(){return this.routes}pushRoutes(e){this.routes=Array.from(new Set(this.routes.concat(e)))}setRoutes(e){this.routes=e}getRepeater(){return this.repeater}setRepeater(e){this.repeater=e}removeRoutes(e){e===void 0?this.routes=[]:this.routes=this.routes.filter(t=>e.indexOf(t)!==-1)}getQueueNameList(e){return D(this,null,function*(){try{if(this.repeater)return yield this.repeater(e);if(this.routes)return this.routes}catch(t){return i.error("exchange function getstringList exception"),[]}})}};var h=class{constructor(e){this.id=l.random();this.consumedTimes=-1;this.createTime=new Date().getTime(),this.content=e}getId(){return this.id}};var m=class{constructor(e,t){this.id=l.random();this.createTime=new Date().getTime(),this.consume=e,this.payload=t}getId(){return this.id}consumption(e,t){return{then:o=>{try{if(!t)return this.consume(e.content,null,this.payload),o(!0);let u=(c=!0)=>o(c),a=this.consume(e.content,u,this.payload);k(a)?a.then(c=>{o(Boolean(c))}).catch(()=>{o(!1)}):typeof a=="boolean"&&(u=()=>{},o(a))}catch(u){i.error("Consumer consumption error"),o(!1)}}}}};var p=class{constructor(e){this.id=l.random();this.ask=!1;this.rcn=3;this.mode="Random";this.news=[];this.consumerList=[];(e==null?void 0:e.ask)!==void 0&&(this.ask=e.ask),(e==null?void 0:e.news)!==void 0&&(this.news=e.news),(e==null?void 0:e.consumerList)!==void 0&&(this.consumerList=e.consumerList),(e==null?void 0:e.rcn)!==void 0&&(this.rcn=e.rcn),(e==null?void 0:e.mode)!==void 0&&(this.mode=e.mode),(e==null?void 0:e.name)!==void 0&&(this.name=e.name)}getId(){return this.id}getNews(){return this.news}getConsumerList(){return this.consumerList}removeConsumer(e){let t=this.consumerList.findIndex(n=>n.consume===e);return t===-1?!1:(this.consumerList.splice(t,1),!0)}removeAllConsumer(){return this.consumerList=[],!0}removeAllNews(){return this.news=[],!0}removeConsumerById(e){let t=this.consumerList.findIndex(n=>n.getId()===e);return t===-1?!1:(this.consumerList.splice(t,1),!0)}pushConsumer(e){this.consumerList.findIndex(t=>t.getId()===e.getId())===-1&&this.consumerList.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushConsume(e,t){let n=new m(e,t);this.pushConsumer(n)}pushNews(e){e.consumedTimes===-1&&(e.consumedTimes=this.rcn),e.consumedTimes>0&&this.news.findIndex(t=>t.getId()===e.getId())===-1&&this.news.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushContent(e){let t=new h(e);this.pushNews(t)}eject(){if(this.news.length>0)return this.news.splice(0,1)[0]}consumeNews(){if(this.news.length===0||this.consumerList.length===0)return;let e=this.eject();if(e!==null){if(this.mode==="Random"){let t=Math.round(Math.random()*(this.consumerList.length-1)),n=this.consumerList[t];this.consumption(e,n)}else if(this.mode==="All")for(let t of this.consumerList)this.consumption(e,t)}}consumption(e,t){t.consumption(e,this.ask).then(n=>{n?i.log("\u961F\u5217 \u6D88\u8D39\u6210\u529F"):(i.log("\u961F\u5217 \u6D88\u8D39\u5931\u8D25"),e.consumedTimes--,this.pushNews(e)),this.news.length>0&&this.consumeNews()})}};var C=class{has(e){return this.exchangeCollection.has(e)?!0:(i.error(`${e} not find`),!1)}setExchangeCollection(e){this.exchangeCollection=new Map(Object.entries(e))}getExchange(e){if(!!this.has(e))return this.exchangeCollection.get(e)}getExchangeList(){return[...this.exchangeCollection.values()]}getQueueNameList(e,t){if(!!this.has(e))return this.getExchange(e).getQueueNameList(t)}};var Q=class{has(e){return this.queueCollection.has(e)?!0:(i.error(`${e} not find`),!1)}setQueueCollection(e){this.queueCollection=new Map(Object.entries(e))}getQueue(e){if(!!this.has(e))return this.queueCollection.get(e)}getQueueList(){return[...this.queueCollection.values()]}addQueue(e){this.queueCollection.set(e.name,e)}pushNewsToQueue(e,t){!this.has(e)||this.queueCollection.get(e).pushNews(t)}pushContentToQueue(e,t){!this.has(e)||this.queueCollection.get(e).pushContent(t)}subscribeQueue(e,t,n){!this.has(e)||this.queueCollection.get(e).pushConsume(t,n)}unsubscribeQueue(e,t){if(!!this.has(e))return t===void 0?this.queueCollection.get(e).removeAllConsumer():this.queueCollection.get(e).removeConsumer(t)}};var y=class{constructor(e,t){this.exchangeCollectionHandle=new C;this.queueCollectionHandle=new Q;for(let n in e)e[n].name=n;for(let n in t)t[n].name=n;this.exchangeCollectionHandle.setExchangeCollection(e),this.queueCollectionHandle.setQueueCollection(t)}getExchange(e){return this.exchangeCollectionHandle.getExchange(e)}getExchangeList(){return this.exchangeCollectionHandle.getExchangeList()}getQueue(e){return this.queueCollectionHandle.getQueue(e)}getQueueList(){return this.queueCollectionHandle.getQueueList()}addQueue(e){this.queueCollectionHandle.addQueue(e)}pushNewsListToExchange(e,...t){for(let n of t)this.exchangeCollectionHandle.getQueueNameList(e,n.content).then(o=>{for(let u in o)this.pushNewsListToQueue(u,n)})}pushNewsListToQueue(e,...t){for(let n of t)this.queueCollectionHandle.pushNewsToQueue(e,n)}pushContentListToExchange(e,...t){for(let n of t)this.exchangeCollectionHandle.getQueueNameList(e,n).then(o=>{for(let u of o)this.pushContentListToQueue(u,n)})}pushContentListToQueue(e,...t){for(let n of t)this.queueCollectionHandle.pushContentToQueue(e,n)}subscribeQueue(e,t,n){this.queueCollectionHandle.subscribeQueue(e,t,n)}unsubscribeQueue(e,t){this.queueCollectionHandle.unsubscribeQueue(e,t)}};function L(s,e){return new d(s,e)}var d=class extends y{constructor(t,n){super(t,n);this.installedPlugins=new Set}use(t,...n){if(this.installedPlugins.has(t))console.log("Plugin has already been applied to target unmq.");else{if(t&&f(t.install))return this.installedPlugins.add(t),t.install(this,...n);if(f(t))return this.installedPlugins.add(t),t(this,...n)}}emit(t,...n){return super.pushContentListToExchange(t,...n),this}emitToQueue(t,...n){return super.pushContentListToQueue(t,...n),this}on(t,n,o){return super.subscribeQueue(t,n,o),()=>this.off(t,n)}off(t,n){return super.unsubscribeQueue(t,n),this}once(t,n,o){let u=0,a=(c,r,g)=>{if(u!==1)return u++,this.off(t,a),n(c,r,g)};return this.on(t,a,o),this}};var M=d;var q=Object.assign,E=Object.prototype.toString,b=s=>E.call(s),H=Array.isArray,j=s=>b(s)==="[object Map]",A=s=>b(s)==="[object Set]",F=s=>s instanceof Date,f=s=>typeof s=="function",O=s=>typeof s=="string",U=s=>typeof s=="number",B=s=>typeof s=="boolean",$=s=>typeof s=="symbol",T=s=>s!==null&&typeof s=="object",k=s=>T(s)&&f(s.then)&&f(s.catch);0&&(module.exports={Consumer,Exchange,Logs,News,Queue,createUnmq,extend,isArray,isBoolean,isDate,isFunction,isMap,isNumber,isObject,isPromise,isSet,isString,isSymbol,objectToString,toTypeString});
