{
  "version": 3,
  "sources": ["../../../src/utils/tools.ts", "../../../src/internal/Logs.ts", "../../../src/internal/News.ts", "../../../src/internal/Consumer.ts", "../../../src/internal/Queue.ts", "../../../src/index.ts", "../../../src/plugins/iframe/loader.ts", "../../../src/plugins/iframe/index.ts"],
  "sourcesContent": ["/**\r\n * \u5DE5\u5177\u7C7B\r\n */\r\nexport default class Tools {\r\n  /**\r\n   * \u83B7\u53D6\u968F\u673A\u6570\r\n   * @returns\r\n   */\r\n  static random(): string {\r\n    return String(Math.round(Math.random() * 10000000000))\r\n  }\r\n  static promiseSetTimeout = (time = 0) =>\r\n    new Promise((resolve) => setTimeout(resolve, time))\r\n\r\n  /**\r\n   * \u83B7\u53D6\u683C\u5F0F\u5316\u65F6\u95F4\r\n   * @returns\r\n   */\r\n  static getTimeFormat(time?: string | number): string {\r\n    let now = null\r\n    if (time) now = new Date(time)\r\n    else now = new Date()\r\n\r\n    const year = now.getFullYear() //\u5E74\r\n    const month = now.getMonth() + 1 //\u6708\r\n    const day = now.getDate() //\u65E5\r\n\r\n    const hh = now.getHours() //\u65F6\r\n    const mm = now.getMinutes() //\u5206\r\n\r\n    let clock = year + '-'\r\n\r\n    if (month < 10) clock += '0'\r\n    clock += month + '-'\r\n\r\n    if (day < 10) clock += '0'\r\n    clock += day + ' '\r\n\r\n    if (hh < 10) clock += '0'\r\n    clock += hh + ':'\r\n    if (mm < 10) clock += '0'\r\n    clock += mm\r\n    return clock\r\n  }\r\n\r\n  /**\r\n   *   //\u5B57\u7B26\u7F16\u7801\u6570\u503C\u5BF9\u5E94\u7684\u5B58\u50A8\u957F\u5EA6\uFF1A\r\n  //UCS-2\u7F16\u7801(16\u8FDB\u5236) UTF-8 \u5B57\u8282\u6D41(\u4E8C\u8FDB\u5236)\r\n  //0000 - 007F       0xxxxxxx \uFF081\u5B57\u8282\uFF09\r\n  //0080 - 07FF       110xxxxx 10xxxxxx \uFF082\u5B57\u8282\uFF09\r\n  //0800 - FFFF       1110xxxx 10xxxxxx 10xxxxxx \uFF083\u5B57\u8282\uFF09\r\n   * @param str \r\n   * @returns \r\n   */\r\n  static memorySize = (str: string): string => {\r\n    let totalLength = 0\r\n    let charCode\r\n    for (let i = 0; i < str.length; i++) {\r\n      charCode = str.charCodeAt(i)\r\n      if (charCode < 0x007f) {\r\n        totalLength++\r\n      } else if (0x0080 <= charCode && charCode <= 0x07ff) {\r\n        totalLength += 2\r\n      } else if (0x0800 <= charCode && charCode <= 0xffff) {\r\n        totalLength += 3\r\n      } else {\r\n        totalLength += 4\r\n      }\r\n    }\r\n    if (totalLength >= 1024 * 1024)\r\n      return (totalLength / (1024 * 1024)).toFixed(2) + 'MB'\r\n    if (totalLength >= 1024 && totalLength < 1024 * 1024)\r\n      return (totalLength / 1024).toFixed(2) + 'KB'\r\n    else return totalLength + 'B'\r\n  }\r\n}\r\n", "export default class Logs {\r\n  static unmq = null; //new UNodeMQ({ exchangeName: \"logs\", queueName: [\"error\"] });\r\n  static error(message: any) {\r\n    // this.unmq.emit()\r\n    console.error(message);\r\n  }\r\n  static log(message: any) {\r\n    console.log(message);\r\n  }\r\n}\r\n", "import Tools from \"../utils/tools\";\r\n\r\nexport default class News<D> {\r\n  /**\r\n   * id\r\n   */\r\n  private readonly id: string = Tools.random();\r\n  getId() {\r\n    return this.id;\r\n  }\r\n  /**\r\n   * \u6D88\u8D39\u8005\u521B\u5EFA\u65F6\u95F4\u6233\r\n   */\r\n  readonly createTime: number;\r\n  /**\r\n   * \u6D88\u606F\u5185\u5BB9\r\n   */\r\n  readonly content: D;\r\n  /**\r\n   * \u5269\u4F59\u53EF\u91CD\u590D\u6D88\u8D39\u6B21\u6570\r\n   */\r\n  consumedTimes: number = -1;\r\n\r\n  constructor(content: D) {\r\n    this.createTime = new Date().getTime();\r\n    this.content = content;\r\n  }\r\n}\r\n", "import { isPromise } from \"../index\";\r\nimport Tools from \"../utils/tools\";\r\nimport Logs from \"./Logs\";\r\nimport News from \"./News\";\r\nexport type Next = (value?: boolean) => void;\r\n\r\nexport interface Consume<D> {\r\n  (content: D, next?: Next, payload?: any): Promise<any> | any;\r\n  (content: D, payload?: any): any;\r\n}\r\ntype ThenParameter<D> = (isOk: boolean) => void;\r\ninterface Payload<D> {\r\n  then: (res: ThenParameter<D>) => void;\r\n}\r\nexport default class Consumer<D> {\r\n  /**\r\n   * id\r\n   */\r\n  private readonly id: string = Tools.random();\r\n  getId() {\r\n    return this.id;\r\n  }\r\n  /**\r\n   * \u6D88\u8D39\u8005\u521B\u5EFA\u65F6\u95F4\u6233\r\n   */\r\n  createTime: number;\r\n  /**\r\n   * \u6D88\u8D39\u65B9\u6CD5\r\n   */\r\n  consume: Consume<D>;\r\n  /**\r\n   * \u56FA\u5B9A\u53C2\u6570\r\n   */\r\n  payload?: any;\r\n  constructor(consume: Consume<D>, payload?: any) {\r\n    this.createTime = new Date().getTime();\r\n    this.consume = consume;\r\n    this.payload = payload;\r\n  }\r\n  /**\r\n   * \u6D88\u8D39\u6D88\u606F\r\n   * @param news\r\n   * @param ask\r\n   * @returns\r\n   */\r\n  consumption(news: News<D>, ask: boolean): Payload<D> {\r\n    const then = (thenParameter: ThenParameter<D>) => {\r\n      //\u4E0D\u52A0\u5165\u4EFB\u52A1\u961F\u5217\uFF0C\u4F1A\u5BFC\u81F4\u6D88\u8D39\u5931\u8D25\u7684\u6570\u636E\u91CD\u5199\u5230\u961F\u5217\u5931\u8D25\r\n      try {\r\n        if (!ask) {\r\n          //\u4E0D\u9700\u8981\u786E\u8BA4\u7684\u6D88\u8D39\u65B9\u6CD5\r\n          this.consume(news.content, this.payload);\r\n          return thenParameter(true);\r\n        }\r\n        //\u6784\u5EFA\u6D88\u606F\u786E\u8BA4\u7684\u65B9\u6CD5\r\n        let confirm: Next = (value = true) => thenParameter(value);\r\n        //\u9700\u8981\u786E\u8BA4\u7684\u6D88\u8D39\u65B9\u6CD5\r\n        const res = this.consume(news.content, confirm, this.payload);\r\n        //\u5982\u679C\u6D88\u606F\u9700\u8981\u786E\u8BA4\uFF0C\u4E14\u8FD4\u56DE\u7684\u5185\u5BB9\u4E3APromise\r\n        if (isPromise(res)) {\r\n          res\r\n            .then((onfulfilled) => {\r\n              thenParameter(Boolean(onfulfilled));\r\n            })\r\n            .catch(() => {\r\n              thenParameter(false);\r\n            });\r\n        } else if (typeof res === \"boolean\") {\r\n          confirm = () => {};\r\n          thenParameter(res);\r\n        }\r\n      } catch (error) {\r\n        Logs.error(\"Consumer consumption error\");\r\n        thenParameter(!ask);\r\n      }\r\n    };\r\n    return {\r\n      then,\r\n    };\r\n  }\r\n}\r\n", "import News from \"./News\";\r\nimport Consumer, { Consume } from \"./Consumer\";\r\nimport Logs from \"./Logs\";\r\nimport Tools from \"../utils/tools\";\r\ninterface Option<D> {\r\n  ask?: boolean;\r\n  rcn?: number;\r\n  news?: News<D>[];\r\n  consumerList?: Consumer<D>[];\r\n  mode?: ConsumMode;\r\n  name?: string;\r\n}\r\nexport enum ConsumMode {\r\n  \"Random\" = \"Random\",\r\n  \"All\" = \"All\",\r\n}\r\n/**\r\n * \u961F\u5217\uFF0C\u7406\u8BBA\u4E0A\u4E00\u4E2A\u961F\u5217\u7684\u6570\u636E\u683C\u5F0F\u5E94\u8BE5\u5177\u6709\u4E00\u81F4\u6027\r\n */\r\nexport default class Queue<D> {\r\n  [k: string]: any;\r\n  name?: string;\r\n  /**\r\n   * id\r\n   */\r\n  private readonly id: string = Tools.random();\r\n  getId() {\r\n    return this.id;\r\n  }\r\n  /**\r\n   * \u662F\u5426\u9700\u8981\u6D88\u606F\u786E\u8BA4\r\n   */\r\n  ask: boolean = false;\r\n  /**\r\n   * \u53EF\u91CD\u65B0\u6D88\u8D39\u6B21\u6570\uFF0C\u6D88\u8D39\u5931\u8D25\u4F1A\u91CD\u590D\u6D88\u8D39\r\n   */\r\n  rcn: number = 3;\r\n  /**\r\n   * \u6D88\u8D39\u6A21\u5F0F\r\n   */\r\n  mode: ConsumMode = ConsumMode.Random;\r\n  /**\r\n   * \u6D88\u606F list\r\n   */\r\n  private news: News<D>[] = [];\r\n  getNews() {\r\n    return this.news;\r\n  }\r\n  /**\r\n   * \u6D88\u8D39\u8005 list\r\n   */\r\n  private consumerList: Consumer<D>[] = [];\r\n  getConsumerList() {\r\n    return this.consumerList;\r\n  }\r\n  constructor(option?: Option<D>) {\r\n    if (option?.ask !== undefined) this.ask = option.ask;\r\n    if (option?.news !== undefined) this.news = option.news;\r\n    if (option?.consumerList !== undefined) this.consumerList = option.consumerList;\r\n    if (option?.rcn !== undefined) this.rcn = option.rcn;\r\n    if (option?.mode !== undefined) this.mode = option.mode;\r\n    if (option?.name !== undefined) this.name = option.name;\r\n  }\r\n  /**\r\n   * \u901A\u8FC7\u6D88\u8D39\u65B9\u6CD5\u79FB\u9664\u6307\u5B9A\u6D88\u8D39\u8005\r\n   * @param consume\r\n   * @returns\r\n   */\r\n  removeConsumer(consume: Consume<D>) {\r\n    const index = this.consumerList.findIndex((item) => item.consume === consume);\r\n    if (index === -1) return false;\r\n    this.consumerList.splice(index, 1);\r\n    return true;\r\n  }\r\n  /**\r\n   * \u79FB\u9664\u6240\u6709\u6D88\u8D39\u8005\r\n   * @returns\r\n   */\r\n  removeAllConsumer() {\r\n    this.consumerList = [];\r\n    return true;\r\n  }\r\n  /**\r\n   * \u79FB\u9664\u6240\u6709\u6D88\u606F\r\n   * @returns\r\n   */\r\n  removeAllNews() {\r\n    this.news = [];\r\n    return true;\r\n  }\r\n  /**\r\n   * \u901A\u8FC7id\u79FB\u9664\u6307\u5B9A\u6D88\u8D39\u8005\r\n   * @param consumerId\r\n   * @returns\r\n   */\r\n  removeConsumerById(consumerId: string) {\r\n    const index = this.consumerList.findIndex((item) => item.getId() === consumerId);\r\n    if (index === -1) return false;\r\n    this.consumerList.splice(index, 1);\r\n    return true;\r\n  }\r\n  /**\r\n   * \u52A0\u5165\u6D88\u8D39\u8005\r\n   * @param consumerList\r\n   */\r\n  pushConsumer(consumer: Consumer<D>) {\r\n    //\u8FC7\u6EE4\u91CD\u590D\u7684\u6D88\u8D39\u8005id\r\n    if (this.consumerList.findIndex((item) => item.getId() === consumer.getId()) === -1)\r\n      this.consumerList.push(consumer);\r\n\r\n    if (this.news.length > 0 && this.consumerList.length > 0) this.consumeNews();\r\n  }\r\n  /**\r\n   * \u52A0\u5165\u6D88\u8D39\u8005\u6D88\u8D39\u4E3B\u4F53\r\n   * @param consume\r\n   * @param payload\r\n   */\r\n  pushConsume(consume: Consume<D>, payload?: any) {\r\n    const consumer = new Consumer(consume, payload);\r\n    this.pushConsumer(consumer);\r\n  }\r\n  /**\r\n   * \u52A0\u5165\u6D88\u606F\r\n   * @param news\r\n   */\r\n  pushNews(news: News<D>) {\r\n    if (news.consumedTimes === -1) news.consumedTimes = this.rcn;\r\n\r\n    if (news.consumedTimes > 0) {\r\n      //\u8FC7\u6EE4\u91CD\u590D\u7684\u6D88\u606Fid\r\n      if (this.news.findIndex((item) => item.getId() === news.getId()) === -1) this.news.push(news);\r\n    }\r\n\r\n    if (this.news.length > 0 && this.consumerList.length > 0) this.consumeNews();\r\n  }\r\n  /**\r\n   * \u52A0\u5165\u6D88\u606F\u5185\u5BB9\r\n   * @param content\r\n   */\r\n  pushContent(content: D) {\r\n    const news = new News(content);\r\n    this.pushNews(news);\r\n  }\r\n\r\n  /**\r\n   * \u5F39\u51FA\u4E00\u6761\u6D88\u606F\r\n   * @returns\r\n   *\r\n   */\r\n  eject(): News<D> | null {\r\n    if (this.news.length > 0) return this.news.splice(0, 1)[0];\r\n    else return null;\r\n  }\r\n  /**\r\n   * \u6D88\u8D39\u65B9\u6CD5\r\n   * \u53EA\u8981\u6D88\u8D39\u8005\u548C\u6D88\u606F\u5B58\u5728\u5C31\u4F1A\u6D88\u8D39\u6389\u6240\u6709\u7684\u6D88\u606F\r\n   * @returns\r\n   */\r\n  consumeNews() {\r\n    if (this.news.length === 0) return;\r\n    if (this.consumerList.length === 0) return;\r\n    const news = this.eject();\r\n    if (news === null) return;\r\n    if (this.mode === ConsumMode.Random) {\r\n      //\u968F\u673A\u6D88\u8D39\u8005\u7684\u7D22\u5F15\r\n      const index = Math.round(Math.random() * (this.consumerList.length - 1));\r\n      const consumer = this.consumerList[index];\r\n      this.consumption(news, consumer);\r\n    } else if (this.mode === ConsumMode.All) {\r\n      for (const consumer of this.consumerList) {\r\n        this.consumption(news, consumer);\r\n      }\r\n    }\r\n  }\r\n  //TODO:\u8BBE\u7F6E\u961F\u5217\u662F\u5426\u662F\u540C\u6B65\u6D88\u8D39\uFF0C\u5982\u679C\u662F\u540C\u6B65\u6D88\u8D39\u5219\u53EA\u80FD\u4E00\u4E2A\u6D88\u606F\u4E00\u4E2A\u6D88\u606F\u6D88\u8D39\r\n  //TODO:\u8BBE\u7F6E\u6D88\u8D39\u8005\u662F\u5426\u662F\u540C\u6B65\u6D88\u8D39\uFF0C\u5982\u679C\u662F\u540C\u6B65\u6D88\u8D39\uFF0C\u5219\u6BCF\u6B21\u53EA\u80FD\u6D88\u8D39\u4E00\u6761\u6D88\u606F\r\n  //TODO:\u589E\u52A0\u6700\u957F\u6D88\u8D39\u65F6\u95F4\r\n  //\u589E\u52A0\u540C\u6B65\u6D88\u8D39\u548C\u5F02\u6B65\u6D88\u8D39\u5C5E\u6027\r\n  consumption(news: News<D>, consumer: Consumer<D>) {\r\n    consumer.consumption(news, this.ask).then((isOk: boolean) => {\r\n      if (isOk) {\r\n        Logs.log(`\u961F\u5217 \u6D88\u8D39\u6210\u529F`);\r\n      } else {\r\n        Logs.log(`\u961F\u5217 \u6D88\u8D39\u5931\u8D25`);\r\n        news.consumedTimes--;\r\n        this.pushNews(news);\r\n      }\r\n      if (this.news.length > 0) this.consumeNews();\r\n    });\r\n  }\r\n}\r\n", "import Exchange from \"./internal/Exchange\";\r\nimport Queue, { ConsumMode } from \"./internal/Queue\";\r\nimport Consumer from \"./internal/Consumer\";\r\nimport News from \"./internal/News\";\r\nimport Logs from \"./internal/Logs\";\r\n\r\nimport UNodeMQ, { createUnmq, createQuickUnmq, QuickUNodeMQ, PluginInstallFunction } from \"./core/UNodeMQ\";\r\nexport default UNodeMQ;\r\n\r\nexport { createUnmq, createQuickUnmq, QuickUNodeMQ, PluginInstallFunction };\r\n\r\nexport { Exchange, Queue, Consumer, News, Logs };\r\n\r\nexport { ConsumMode };\r\n\r\nexport const extend = Object.assign;\r\nexport const objectToString = Object.prototype.toString;\r\nexport const toTypeString = (value: unknown): string => objectToString.call(value);\r\nexport const isArray = Array.isArray;\r\nexport const isMap = (val: unknown): val is Map<any, any> => toTypeString(val) === \"[object Map]\";\r\nexport const isSet = (val: unknown): val is Set<any> => toTypeString(val) === \"[object Set]\";\r\n\r\nexport const isDate = (val: unknown): val is Date => val instanceof Date;\r\nexport const isFunction = (val: unknown): val is Function => typeof val === \"function\";\r\nexport const isString = (val: unknown): val is string => typeof val === \"string\";\r\nexport const isNumber = (val: unknown): val is number => typeof val === \"number\";\r\nexport const isBoolean = (val: unknown): val is boolean => typeof val === \"boolean\";\r\nexport const isSymbol = (val: unknown): val is symbol => typeof val === \"symbol\";\r\nexport const isObject = (val: unknown): val is Record<any, any> => val !== null && typeof val === \"object\";\r\n\r\nexport const isPromise = <T = any>(val: unknown): val is Promise<T> => {\r\n  return isObject(val) && isFunction(val.then) && isFunction(val.catch);\r\n};\r\n\r\n//TODO:\u8FD0\u884C\u901A\u8FC7\u6784\u9020\u51FD\u6570\u52A8\u6001\u5411Exchange\u548CQueue\u6DFB\u52A0\u5C5E\u6027\r\n", "/**\r\n * \u997C\u5E73\u5316\u65B9\u4FBF\u53D6\u503C\r\n * \u4F46\u662F\u9700\u8981\u6807\u8BB0\u6BCF\u4E2Awindow\u5728\u591A\u7EF4\u6570\u7EC4\u4E2D\u7684\u4F4D\u7F6E\r\n * window\u4E3A\u7B2C\u4E00\u5C42\uFF0C\u8BB0\u4E3A0\uFF0C0\r\n * window\u4E0B\u7B2C\u4E00\u4E2Aiframe\u8BB0\u4E3A0\uFF0C1\r\n * y \u662F\u6DF1\u5EA6\r\n *\r\n * x \u662F\u7D22\u5F15\r\n *\r\n * \u53EA\u8981\u6709\u4E00\u4E2Awindow\u4EA7\u751F\u5C31\u5168\u5C40\u6838\u5BF9\u5750\u6807\u70B9\r\n * \u53EA\u8981\u6709\u4E00\u4E2AIframeMessage\u88AB\u521B\u5EFA\u5219\u4EE3\u8868\u5F53\u524D\u521B\u5EFA\u4E86\u4E00\u4E2Awindow\r\n *\r\n *\r\n */\r\n\r\n/**\r\n * \u83B7\u53D6\u5176\u4ED6\u6240\u6709Iframe doc\r\n * @returns\r\n */\r\nexport function getOtherAllIframeDoc(): T[] {\r\n  if (window.top === null) throw \"window.top is null\";\r\n  const list = getAllIframeDoc(window.top, 0, 0);\r\n  return list.filter((item) => item.window !== window.self);\r\n}\r\n/**\r\n * \u83B7\u53D6\u81EA\u5DF1\u7684iframe doc\r\n * @returns\r\n */\r\nexport function getSelfIframeDoc() {\r\n  if (window.top === null) throw \"window.top is null\";\r\n  const list = getAllIframeDoc(window.top, 0, 0);\r\n  return list.find((item) => item.window === window.self);\r\n}\r\ntype T = {\r\n  window: Window;\r\n  x: number;\r\n  y: number;\r\n};\r\n/**\r\n * \u83B7\u53D6\u6240\u6709node doc\r\n * @param w\r\n * @param x\r\n * @param y\r\n * @returns\r\n */\r\nexport function getAllIframeDoc(w: Window, x: number, y: number): T[] {\r\n  const arr = [];\r\n  arr.push({\r\n    window: w,\r\n    x,\r\n    y,\r\n  });\r\n  y += 1;\r\n  for (let k = 0; k < w.length; k++) {\r\n    arr.push(...getAllIframeDoc(w[k], x, y));\r\n    x += 1;\r\n  }\r\n  return arr;\r\n}\r\n", "import UNodeMQ, { Exchange, isObject, isString, Queue } from \"../../index\";\r\nimport { getOtherAllIframeDoc } from \"./loader\";\r\n//TODO:\u89E3\u51B3\u63D2\u4EF6\u5F15\u7528\u8DEF\u5F84\u957F\u5EA6\u95EE\u9898\r\n//TODO:\u8DE8iframe\u5171\u4EABstorage\r\n//TODO:\u5355\u5143\u6D4B\u8BD5\u6846\u67B6\u96C6\u6210\r\nexport enum MessageType {\r\n  GeneralMessage, //\u666E\u901A\u6D88\u606F\r\n  FindExchangeMessage, //\u5E7F\u64AD\u67E5\u627E\u4EA4\u6362\u673A\u6D88\u606F\r\n  SendCoordinateMessage, //\u53D1\u9001exchange\u5750\u6807\u6D88\u606F\r\n  OnlineNotificationMessage, //\u4E0A\u7EBF\u901A\u77E5\u6D88\u606F\r\n}\r\n//\u76F4\u53D1\u6D88\u606F\u961F\u5217\uFF0C\u5373\u4E3B\u52A8\u53D1\u9001\r\nexport const getInternalIframeMessageQueueName = (queueName: string) => queueName + \"_Iframe_Message\";\r\n//\u7528\u6765\u5E7F\u64AD\u83B7\u53D6\u5730\u5740\u7684\u6D88\u606F\r\nexport const getInternalIframeBroadcasMessageQueueName = (queueName: string) => queueName + \"_Iframe_Wait_Message\";\r\n\r\nexport default class IframePlugin {\r\n  private unmq: UNodeMQ<Record<string, Exchange<any>>, Record<string, Queue<any>>> | null = null;\r\n  constructor(private readonly name: string) {\r\n    this.name = name;\r\n  }\r\n  install(unmq: UNodeMQ<Record<string, Exchange<any>>, Record<string, Queue<any>>>, ...options: any[]) {\r\n    const selfExchange = unmq.getExchange(this.name);\r\n    if (!selfExchange) {\r\n      throw `${this.name}\u4EA4\u6362\u673A\u4E0D\u5B58\u5728`;\r\n    }\r\n    this.unmq = unmq;\r\n    const list = unmq.getExchangeList();\r\n    const otherIframe = list.filter((item) => item.name !== this.name);\r\n\r\n    for (const iframe of otherIframe) {\r\n      if (iframe.name === undefined) throw `\u7CFB\u7EDF\u9519\u8BEF`;\r\n      iframe.setRepeater(() => [\r\n        getInternalIframeMessageQueueName(iframe.name as string),\r\n        getInternalIframeBroadcasMessageQueueName(iframe.name as string),\r\n      ]);\r\n      //\u7528\u4E8E\u5B58\u50A8\u6D88\u606F\u7684\u961F\u5217\r\n      unmq.addQueue(new Queue({ name: getInternalIframeMessageQueueName(iframe.name) }));\r\n      //\u7528\u6765\u5E7F\u64AD\u83B7\u53D6\u5730\u5740\u7684\u6D88\u606F\r\n      unmq.addQueue(new Queue({ name: getInternalIframeBroadcasMessageQueueName(iframe.name) }));\r\n\r\n      //\u4E3A\u5E7F\u64AD\u6D88\u606F\u6302\u8F7D\u6D88\u8D39\u65B9\u6CD5\r\n      unmq.on(getInternalIframeBroadcasMessageQueueName(iframe.name), () => {\r\n        //\u5E7F\u64AD\u67E5\u627E\u4EA4\u6362\u673A\u5730\u5740\u6D88\u606F\r\n        this.broadcastMessage(MessageType.FindExchangeMessage, {\r\n          exchangeName: iframe.name,\r\n          msg: `who is ${this.name}`,\r\n        });\r\n      });\r\n    }\r\n\r\n    //\u5E7F\u64AD\u53D1\u9001\u4E0A\u7EBF\u901A\u77E5\r\n    this.broadcastMessage(MessageType.OnlineNotificationMessage, null);\r\n\r\n    //\u76D1\u542Cunmq\u7684\u6D88\u606F\r\n    window.addEventListener(\"message\", this.receiveMessage.bind(this), false);\r\n  }\r\n  /**\r\n   *\r\n   * @param param0\r\n   * @returns\r\n   */\r\n  private receiveMessage({ source, data, origin }: MessageEventInit) {\r\n    if (this.unmq === null) throw `${this.name} iframe \u672A\u5B89\u88C5`;\r\n    if (!isObject(data)) return;\r\n    const { mask, type, message, fromName } = data;\r\n    if (mask !== \"u-node-mq-plugin\") return;\r\n    if (source === null || source === undefined) return;\r\n    if (!(source instanceof Window)) return;\r\n    if ([MessageType.OnlineNotificationMessage, MessageType.SendCoordinateMessage].indexOf(type) !== -1) {\r\n      ///////////\u9700\u8981\u5224\u65AD\u6765\u6E90\u7684\u6D88\u606F\r\n      //\u53D1\u9001\u8005\u662F\u5426\u5B58\u5728\r\n      const fromIframe = this.unmq.getExchange(fromName);\r\n      if (!fromIframe) return;\r\n      //\u5224\u65AD\u771F\u5B9E\u7684origin \u662F\u5426\u662F\u6211\u60F3\u8981\u7684 origin\r\n      if (isString(fromIframe.origin) && fromIframe.origin !== origin) return;\r\n      // \u62FF\u5230\u5BF9\u65B9\u5750\u6807\uFF0C\u51C6\u5907\u53D1\u9001\u6D88\u606F\r\n      this.unmq.on(getInternalIframeMessageQueueName(fromName), (data) => {\r\n        this.postMessage(source, MessageType.GeneralMessage, data, origin);\r\n      })();\r\n      return true;\r\n    }\r\n\r\n    ///////////\u4E0D\u9700\u8981\u5224\u65AD\u6765\u6E90\u7684\u6D88\u606F\r\n\r\n    //\u666E\u901A\u6D88\u606F\r\n    if (type === MessageType.GeneralMessage) return this.unmq.emit(this.name, message);\r\n\r\n    //\u67E5\u627E\u4EA4\u6362\u673A\u6D88\u606F\r\n    if (type === MessageType.FindExchangeMessage && message.exchangeName === this.name) {\r\n      this.postMessage(source, MessageType.SendCoordinateMessage, { msg: `my name is ${this.name}` }, origin);\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\u53D1\u9001\u6D88\u606F\r\n   * @param currentWindow\r\n   * @param type\r\n   * @param message\r\n   * @param origin\r\n   * @param transfer\r\n   */\r\n  private postMessage(\r\n    currentWindow: Window,\r\n    type: MessageType,\r\n    message: any,\r\n    origin: string = \"*\",\r\n    transfer?: Transferable[]\r\n  ) {\r\n    currentWindow.postMessage(\r\n      {\r\n        mask: \"u-node-mq-plugin\",\r\n        type,\r\n        message,\r\n        fromName: this.name,\r\n      },\r\n      origin,\r\n      transfer\r\n    );\r\n  }\r\n  /**\r\n   *\u5E7F\u64AD\u6D88\u606F\r\n   * @param type\r\n   * @param message\r\n   */\r\n  private broadcastMessage(type: MessageType, message: any) {\r\n    const list = getOtherAllIframeDoc();\r\n    list.forEach((item) => {\r\n      this.postMessage(item.window, type, message, \"*\");\r\n    });\r\n  }\r\n}\r\n"],
  "mappings": "MAGA,WAA2B,OAKlB,SAAiB,CACtB,MAAO,QAAO,KAAK,MAAM,KAAK,OAAO,EAAI,IAAW,CAAC,CACvD,OAQO,eAAc,EAAgC,CACnD,GAAI,GAAM,KACV,AAAI,EAAM,EAAM,GAAI,MAAK,CAAI,EACxB,EAAM,GAAI,MAEf,GAAM,GAAO,EAAI,YAAY,EACvB,EAAQ,EAAI,SAAS,EAAI,EACzB,EAAM,EAAI,QAAQ,EAElB,EAAK,EAAI,SAAS,EAClB,EAAK,EAAI,WAAW,EAEtB,EAAQ,EAAO,IAEnB,MAAI,GAAQ,IAAI,IAAS,KACzB,GAAS,EAAQ,IAEb,EAAM,IAAI,IAAS,KACvB,GAAS,EAAM,IAEX,EAAK,IAAI,IAAS,KACtB,GAAS,EAAK,IACV,EAAK,IAAI,IAAS,KACtB,GAAS,EACF,CACT,CAgCF,EAhES,AART,EAQS,kBAAoB,CAAC,EAAO,IACjC,GAAI,SAAQ,AAAC,GAAY,WAAW,EAAS,CAAI,CAAC,EA0C7C,AAnDT,EAmDS,WAAa,AAAC,GAAwB,CAC3C,GAAI,GAAc,EACd,EACJ,OAAS,GAAI,EAAG,EAAI,EAAI,OAAQ,IAC9B,EAAW,EAAI,WAAW,CAAC,EAC3B,AAAI,EAAW,IACb,IACK,AAAI,KAAU,GAAY,GAAY,KAC3C,GAAe,EACV,AAAI,MAAU,GAAY,GAAY,MAC3C,GAAe,EAEf,GAAe,EAGnB,MAAI,IAAe,KAAO,KAChB,GAAe,MAAO,OAAO,QAAQ,CAAC,EAAI,KAChD,GAAe,MAAQ,EAAc,KAAO,KACtC,GAAc,MAAM,QAAQ,CAAC,EAAI,KAC/B,EAAc,GAC5B,EC1EF,WAA0B,OAEjB,OAAM,EAAc,CAEzB,QAAQ,MAAM,CAAO,CACvB,OACO,KAAI,EAAc,CACvB,QAAQ,IAAI,CAAO,CACrB,CACF,EARS,AADT,EACS,KAAO,KCChB,WAA6B,CAqB3B,YAAY,EAAY,CAjBP,QAAa,EAAM,OAAO,EAe3C,mBAAwB,GAGtB,KAAK,WAAa,GAAI,MAAK,EAAE,QAAQ,EACrC,KAAK,QAAU,CACjB,CAnBA,OAAQ,CACN,MAAO,MAAK,EACd,CAkBF,ECbA,WAAiC,CAoB/B,YAAY,EAAqB,EAAe,CAhB/B,QAAa,EAAM,OAAO,EAiBzC,KAAK,WAAa,GAAI,MAAK,EAAE,QAAQ,EACrC,KAAK,QAAU,EACf,KAAK,QAAU,CACjB,CAnBA,OAAQ,CACN,MAAO,MAAK,EACd,CAwBA,YAAY,EAAe,EAA0B,CA+BnD,MAAO,CACL,KA/BW,AAAC,GAAoC,CAEhD,GAAI,CACF,GAAI,CAAC,EAEH,YAAK,QAAQ,EAAK,QAAS,KAAK,OAAO,EAChC,EAAc,EAAI,EAG3B,GAAI,GAAgB,CAAC,EAAQ,KAAS,EAAc,CAAK,EAEnD,EAAM,KAAK,QAAQ,EAAK,QAAS,EAAS,KAAK,OAAO,EAE5D,AAAI,EAAU,CAAG,EACf,EACG,KAAK,AAAC,GAAgB,CACrB,EAAc,QAAQ,CAAW,CAAC,CACpC,CAAC,EACA,MAAM,IAAM,CACX,EAAc,EAAK,CACrB,CAAC,EACM,MAAO,IAAQ,WACxB,GAAU,IAAM,CAAC,EACjB,EAAc,CAAG,EAErB,OAAS,EAAP,CACA,EAAK,MAAM,4BAA4B,EACvC,EAAc,CAAC,CAAG,CACpB,CACF,CAGA,CACF,CACF,EC7DA,WAA8B,CAoC5B,YAAY,EAAoB,CA9Bf,QAAa,EAAM,OAAO,EAO3C,SAAe,GAIf,SAAc,EAId,UAAmB,SAIX,UAAkB,CAAC,EAOnB,kBAA8B,CAAC,EAKrC,AAAI,kBAAQ,OAAQ,QAAW,MAAK,IAAM,EAAO,KAC7C,kBAAQ,QAAS,QAAW,MAAK,KAAO,EAAO,MAC/C,kBAAQ,gBAAiB,QAAW,MAAK,aAAe,EAAO,cAC/D,kBAAQ,OAAQ,QAAW,MAAK,IAAM,EAAO,KAC7C,kBAAQ,QAAS,QAAW,MAAK,KAAO,EAAO,MAC/C,kBAAQ,QAAS,QAAW,MAAK,KAAO,EAAO,KACrD,CApCA,OAAQ,CACN,MAAO,MAAK,EACd,CAiBA,SAAU,CACR,MAAO,MAAK,IACd,CAKA,iBAAkB,CAChB,MAAO,MAAK,YACd,CAcA,eAAe,EAAqB,CAClC,GAAM,GAAQ,KAAK,aAAa,UAAU,AAAC,GAAS,EAAK,UAAY,CAAO,EAC5E,MAAI,KAAU,GAAW,GACzB,MAAK,aAAa,OAAO,EAAO,CAAC,EAC1B,GACT,CAKA,mBAAoB,CAClB,YAAK,aAAe,CAAC,EACd,EACT,CAKA,eAAgB,CACd,YAAK,KAAO,CAAC,EACN,EACT,CAMA,mBAAmB,EAAoB,CACrC,GAAM,GAAQ,KAAK,aAAa,UAAU,AAAC,GAAS,EAAK,MAAM,IAAM,CAAU,EAC/E,MAAI,KAAU,GAAW,GACzB,MAAK,aAAa,OAAO,EAAO,CAAC,EAC1B,GACT,CAKA,aAAa,EAAuB,CAElC,AAAI,KAAK,aAAa,UAAU,AAAC,GAAS,EAAK,MAAM,IAAM,EAAS,MAAM,CAAC,IAAM,IAC/E,KAAK,aAAa,KAAK,CAAQ,EAE7B,KAAK,KAAK,OAAS,GAAK,KAAK,aAAa,OAAS,GAAG,KAAK,YAAY,CAC7E,CAMA,YAAY,EAAqB,EAAe,CAC9C,GAAM,GAAW,GAAI,GAAS,EAAS,CAAO,EAC9C,KAAK,aAAa,CAAQ,CAC5B,CAKA,SAAS,EAAe,CACtB,AAAI,EAAK,gBAAkB,IAAI,GAAK,cAAgB,KAAK,KAErD,EAAK,cAAgB,GAEnB,KAAK,KAAK,UAAU,AAAC,GAAS,EAAK,MAAM,IAAM,EAAK,MAAM,CAAC,IAAM,IAAI,KAAK,KAAK,KAAK,CAAI,EAG1F,KAAK,KAAK,OAAS,GAAK,KAAK,aAAa,OAAS,GAAG,KAAK,YAAY,CAC7E,CAKA,YAAY,EAAY,CACtB,GAAM,GAAO,GAAI,GAAK,CAAO,EAC7B,KAAK,SAAS,CAAI,CACpB,CAOA,OAAwB,CACtB,MAAI,MAAK,KAAK,OAAS,EAAU,KAAK,KAAK,OAAO,EAAG,CAAC,EAAE,GAC5C,IACd,CAMA,aAAc,CAEZ,GADI,KAAK,KAAK,SAAW,GACrB,KAAK,aAAa,SAAW,EAAG,OACpC,GAAM,GAAO,KAAK,MAAM,EACxB,GAAI,IAAS,MACb,GAAI,KAAK,OAAS,SAAmB,CAEnC,GAAM,GAAQ,KAAK,MAAM,KAAK,OAAO,EAAK,MAAK,aAAa,OAAS,EAAE,EACjE,EAAW,KAAK,aAAa,GACnC,KAAK,YAAY,EAAM,CAAQ,CACjC,SAAW,KAAK,OAAS,MACvB,OAAW,KAAY,MAAK,aAC1B,KAAK,YAAY,EAAM,CAAQ,EAGrC,CAKA,YAAY,EAAe,EAAuB,CAChD,EAAS,YAAY,EAAM,KAAK,GAAG,EAAE,KAAK,AAAC,GAAkB,CAC3D,AAAI,EACF,EAAK,IAAI,uCAAS,EAElB,GAAK,IAAI,uCAAS,EAClB,EAAK,gBACL,KAAK,SAAS,CAAI,GAEhB,KAAK,KAAK,OAAS,GAAG,KAAK,YAAY,CAC7C,CAAC,CACH,CACF,EC5KO,GAAM,IAAU,MAAM,QAKtB,GAAM,GAAa,AAAC,GAAkC,MAAO,IAAQ,WAC/D,EAAW,AAAC,GAAgC,MAAO,IAAQ,SAIjE,GAAM,GAAW,AAAC,GAA0C,IAAQ,MAAQ,MAAO,IAAQ,SAErF,EAAY,AAAU,GAC1B,EAAS,CAAG,GAAK,EAAW,EAAI,IAAI,GAAK,EAAW,EAAI,KAAK,ECZ/D,YAAqC,CAC1C,GAAI,OAAO,MAAQ,KAAM,KAAM,qBAE/B,MAAO,AADM,GAAgB,OAAO,IAAK,EAAG,CAAC,EACjC,OAAO,AAAC,GAAS,EAAK,SAAW,OAAO,IAAI,CAC1D,CAsBO,WAAyB,EAAW,EAAW,EAAgB,CACpE,GAAM,GAAM,CAAC,EACb,EAAI,KAAK,CACP,OAAQ,EACR,IACA,GACF,CAAC,EACD,GAAK,EACL,OAAS,GAAI,EAAG,EAAI,EAAE,OAAQ,IAC5B,EAAI,KAAK,GAAG,EAAgB,EAAE,GAAI,EAAG,CAAC,CAAC,EACvC,GAAK,EAEP,MAAO,EACT,CCrDO,GAAK,GAAL,CAAK,GACV,wCACA,iDACA,qDACA,6DAJU,WAOC,EAAoC,AAAC,GAAsB,EAAY,kBAEvE,EAA4C,AAAC,GAAsB,EAAY,uBAE5F,OAAkC,CAEhC,YAA6B,EAAc,CAAd,YADrB,UAAkF,KAExF,KAAK,KAAO,CACd,CACA,QAAQ,KAA6E,EAAgB,CAEnG,GAAI,CADiB,EAAK,YAAY,KAAK,IAAI,EAE7C,KAAM,GAAG,KAAK,2CAEhB,KAAK,KAAO,EAEZ,GAAM,GAAc,AADP,EAAK,gBAAgB,EACT,OAAO,AAAC,GAAS,EAAK,OAAS,KAAK,IAAI,EAEjE,OAAW,KAAU,GAAa,CAChC,GAAI,EAAO,OAAS,OAAW,KAAM,2BACrC,EAAO,YAAY,IAAM,CACvB,EAAkC,EAAO,IAAc,EACvD,EAA0C,EAAO,IAAc,CACjE,CAAC,EAED,EAAK,SAAS,GAAI,GAAM,CAAE,KAAM,EAAkC,EAAO,IAAI,CAAE,CAAC,CAAC,EAEjF,EAAK,SAAS,GAAI,GAAM,CAAE,KAAM,EAA0C,EAAO,IAAI,CAAE,CAAC,CAAC,EAGzF,EAAK,GAAG,EAA0C,EAAO,IAAI,EAAG,IAAM,CAEpE,KAAK,iBAAiB,EAAiC,CACrD,aAAc,EAAO,KACrB,IAAK,UAAU,KAAK,MACtB,CAAC,CACH,CAAC,CACH,CAGA,KAAK,iBAAiB,EAAuC,IAAI,EAGjE,OAAO,iBAAiB,UAAW,KAAK,eAAe,KAAK,IAAI,EAAG,EAAK,CAC1E,CAMQ,eAAe,CAAE,SAAQ,OAAM,UAA4B,CACjE,GAAI,KAAK,OAAS,KAAM,KAAM,GAAG,KAAK,iCACtC,GAAI,CAAC,EAAS,CAAI,EAAG,OACrB,GAAM,CAAE,OAAM,OAAM,UAAS,YAAa,EAC1C,GAAI,IAAS,oBACT,GAAW,MACT,YAAkB,QACxB,IAAI,CAAC,EAAuC,CAAiC,EAAE,QAAQ,CAAI,IAAM,GAAI,CAGnG,GAAM,GAAa,KAAK,KAAK,YAAY,CAAQ,EAGjD,MAFI,CAAC,GAED,EAAS,EAAW,MAAM,GAAK,EAAW,SAAW,EAAQ,OAEjE,MAAK,KAAK,GAAG,EAAkC,CAAQ,EAAG,AAAC,GAAS,CAClE,KAAK,YAAY,EAAQ,EAA4B,EAAM,CAAM,CACnE,CAAC,EAAE,EACI,GACT,CAKA,GAAI,IAAS,EAA4B,MAAO,MAAK,KAAK,KAAK,KAAK,KAAM,CAAO,EAGjF,AAAI,IAAS,GAAmC,EAAQ,eAAiB,KAAK,MAC5E,KAAK,YAAY,EAAQ,EAAmC,CAAE,IAAK,cAAc,KAAK,MAAO,EAAG,CAAM,EAE1G,CAUQ,YACN,EACA,EACA,EACA,EAAiB,IACjB,EACA,CACA,EAAc,YACZ,CACE,KAAM,mBACN,OACA,UACA,SAAU,KAAK,IACjB,EACA,EACA,CACF,CACF,CAMQ,iBAAiB,EAAmB,EAAc,CAExD,AADa,EAAqB,EAC7B,QAAQ,AAAC,GAAS,CACrB,KAAK,YAAY,EAAK,OAAQ,EAAM,EAAS,GAAG,CAClD,CAAC,CACH,CACF",
  "names": []
}
