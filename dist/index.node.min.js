var D=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var I=(o,e)=>{for(var n in e)D(o,n,{get:e[n],enumerable:!0})},M=(o,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of S(e))!q.call(o,s)&&s!==n&&D(o,s,{get:()=>e[s],enumerable:!(t=R(e,s))||t.enumerable});return o};var H=o=>M(D({},"__esModule",{value:!0}),o);var w=(o,e,n)=>new Promise((t,s)=>{var u=l=>{try{a(n.next(l))}catch(k){s(k)}},r=l=>{try{a(n.throw(l))}catch(k){s(k)}},a=l=>l.done?t(l.value):Promise.resolve(l.value).then(u,r);a((n=n.apply(o,e)).next())});var Y={};I(Y,{ConsumMode:()=>E,Consumer:()=>f,Exchange:()=>g,Logs:()=>i,News:()=>m,Queue:()=>x,QuickUNodeMQ:()=>p,createQuickUnmq:()=>P,createUnmq:()=>L,default:()=>F,extend:()=>A,isArray:()=>j,isBoolean:()=>J,isDate:()=>B,isFunction:()=>h,isMap:()=>O,isNumber:()=>z,isObject:()=>N,isPromise:()=>b,isSet:()=>U,isString:()=>$,isSymbol:()=>K,objectToString:()=>v,toTypeString:()=>T});module.exports=H(Y);var c=class{static random(){return String(Math.round(Math.random()*1e10))}static getTimeFormat(e){let n=null;e?n=new Date(e):n=new Date;let t=n.getFullYear(),s=n.getMonth()+1,u=n.getDate(),r=n.getHours(),a=n.getMinutes(),l=t+"-";return s<10&&(l+="0"),l+=s+"-",u<10&&(l+="0"),l+=u+" ",r<10&&(l+="0"),l+=r+":",a<10&&(l+="0"),l+=a,l}};c.promiseSetTimeout=(e=0)=>new Promise(n=>setTimeout(n,e)),c.memorySize=e=>{let n=0,t;for(let s=0;s<e.length;s++)t=e.charCodeAt(s),t<127?n++:128<=t&&t<=2047?n+=2:2048<=t&&t<=65535?n+=3:n+=4;return n>=1024*1024?(n/(1024*1024)).toFixed(2)+"MB":n>=1024&&n<1024*1024?(n/1024).toFixed(2)+"KB":n+"B"};var i=class{static error(e){console.error(e)}static log(e){console.log(e)}};i.unmq=null;var g=class{constructor(e){this.id=c.random();this.routes=[];this.repeater=()=>this.getRoutes();(e==null?void 0:e.routes)!==void 0&&(this.routes=e.routes),(e==null?void 0:e.repeater)!==void 0&&(this.repeater=e.repeater),(e==null?void 0:e.name)!==void 0&&(this.name=e.name)}getId(){return this.id}getRoutes(){return this.routes}pushRoutes(e){this.routes=Array.from(new Set(this.routes.concat(e)))}setRoutes(e){this.routes=e}getRepeater(){return this.repeater}setRepeater(e){this.repeater=e}removeRoutes(e){e===void 0?this.routes=[]:this.routes=this.routes.filter(n=>e.indexOf(n)!==-1)}getQueueNameList(e){return w(this,null,function*(){try{return yield this.repeater(e)}catch(n){return i.error("exchange function getstringList exception"),[]}})}};var m=class{constructor(e){this.id=c.random();this.consumedTimes=-1;this.createTime=new Date().getTime(),this.content=e}getId(){return this.id}};var f=class{constructor(e,n){this.id=c.random();this.createTime=new Date().getTime(),this.consume=e,this.payload=n}getId(){return this.id}consumption(e,n){return{then:s=>{try{if(!n)return this.consume(e.content,this.payload),s(!0);let u=(a=!0)=>s(a),r=this.consume(e.content,u,this.payload);b(r)?r.then(a=>{s(Boolean(a))}).catch(()=>{s(!1)}):typeof r=="boolean"&&(u=()=>{},s(r))}catch(u){i.error("Consumer consumption error"),s(!n)}}}}};var E=(n=>(n.Random="Random",n.All="All",n))(E||{}),x=class{constructor(e){this.id=c.random();this.ask=!1;this.rcn=3;this.mode="Random";this.async=!1;this.state=!1;this.maxTime=1e3;this.news=[];this.consumerList=[];(e==null?void 0:e.ask)!==void 0&&(this.ask=e.ask),(e==null?void 0:e.news)!==void 0&&(this.news=e.news),(e==null?void 0:e.consumerList)!==void 0&&(this.consumerList=e.consumerList),(e==null?void 0:e.rcn)!==void 0&&(this.rcn=e.rcn),(e==null?void 0:e.mode)!==void 0&&(this.mode=e.mode),(e==null?void 0:e.name)!==void 0&&(this.name=e.name),(e==null?void 0:e.async)!==void 0&&(this.async=e.async),(e==null?void 0:e.maxTime)!==void 0&&(this.maxTime=e.maxTime)}getId(){return this.id}getNews(){return this.news}getConsumerList(){return this.consumerList}removeConsumer(e){let n=this.consumerList.findIndex(t=>t.consume===e);return n===-1?!1:(this.consumerList.splice(n,1),!0)}removeAllConsumer(){return this.consumerList=[],!0}removeAllNews(){return this.news=[],!0}removeConsumerById(e){let n=this.consumerList.findIndex(t=>t.getId()===e);return n===-1?!1:(this.consumerList.splice(n,1),!0)}pushConsumer(e){this.consumerList.findIndex(n=>n.getId()===e.getId())===-1&&this.consumerList.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushConsume(e,n){let t=new f(e,n);this.pushConsumer(t)}pushNews(e){e.consumedTimes===-1&&(e.consumedTimes=this.rcn),e.consumedTimes>0&&this.news.findIndex(n=>n.getId()===e.getId())===-1&&this.news.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushContent(e){let n=new m(e);this.pushNews(n)}eject(){return this.news.length>0?this.news.splice(0,1)[0]:null}consumeNews(){if(this.news.length===0||this.consumerList.length===0||!this.async&&this.state)return;let e=this.eject();if(e===null)return;this.state=!0,(()=>{if(this.mode==="Random"){let t=Math.round(Math.random()*(this.consumerList.length-1)),s=this.consumerList[t];return Promise.all([this.consumption(e,s)])}return Promise.all(this.consumerList.map(t=>this.consumption(e,t)))})().then(()=>{}).catch(()=>{e.consumedTimes--,this.pushNews(e)}).finally(()=>{this.state=!1,this.news.length>0&&this.consumeNews()}),this.async&&this.news.length>0&&this.consumeNews()}consumption(e,n){return new Promise((t,s)=>{let u;this.maxTime>0&&(u=setTimeout(()=>{i.log("\u961F\u5217 \u6D88\u8D39\u8D85\u65F6"),s(!1)},this.maxTime)),n.consumption(e,this.ask).then(r=>{r?(i.log("\u961F\u5217 \u6D88\u8D39\u6210\u529F"),t(r)):(i.log("\u961F\u5217 \u6D88\u8D39\u5931\u8D25"),s(r)),this.maxTime>0&&clearTimeout(u)})})}};var Q=class{constructor(){this.exchangeCollection=new Map}has(e){return this.exchangeCollection.has(e)?!0:(i.error(`${e} not find`),!1)}setExchangeCollection(e){this.exchangeCollection=new Map(Object.entries(e))}getExchange(e){let n=this.exchangeCollection.get(e);return n===void 0?(i.error(`${e} not find`),null):n}getExchangeList(){return[...this.exchangeCollection.values()]}getQueueNameList(e,n){return w(this,null,function*(){let t=this.getExchange(e);return t===null?[]:t.getQueueNameList(n)})}};var C=class{constructor(){this.queueCollection=new Map}has(e){return this.queueCollection.has(e)?!0:(i.error(`${e} not find`),!1)}setQueueCollection(e){this.queueCollection=new Map(Object.entries(e))}getQueue(e){let n=this.queueCollection.get(e);return n===void 0?(i.error(`${e} not find`),null):n}getQueueList(){return[...this.queueCollection.values()]}addQueue(e){if(e.name===void 0)throw"queue.name is undefined";this.queueCollection.set(e.name,e)}pushNewsToQueue(e,n){var t;(t=this.getQueue(e))==null||t.pushNews(n)}pushContentToQueue(e,n){var t;(t=this.getQueue(e))==null||t.pushContent(n)}subscribeQueue(e,n,t){var s;(s=this.getQueue(e))==null||s.pushConsume(n,t)}unsubscribeQueue(e,n){var t,s;return this.has(e)?h(n)?!!((t=this.getQueue(e))!=null&&t.removeConsumer(n)):!!((s=this.getQueue(e))!=null&&s.removeAllConsumer()):!1}};var y=class{constructor(e,n){this.exchangeCollectionHandle=new Q;this.queueCollectionHandle=new C;for(let t in e)e[t].name=t;for(let t in n)n[t].name=t;this.exchangeCollectionHandle.setExchangeCollection(e),this.queueCollectionHandle.setQueueCollection(n)}getExchange(e){return this.exchangeCollectionHandle.getExchange(e)}getExchangeList(){return this.exchangeCollectionHandle.getExchangeList()}getQueue(e){return this.queueCollectionHandle.getQueue(e)}getQueueList(){return this.queueCollectionHandle.getQueueList()}addQueue(e){this.queueCollectionHandle.addQueue(e)}pushNewsListToExchange(e,...n){for(let t of n)this.exchangeCollectionHandle.getQueueNameList(e,t.content).then(s=>{for(let u in s)this.pushNewsListToQueue(u,t)})}pushNewsListToQueue(e,...n){for(let t of n)this.queueCollectionHandle.pushNewsToQueue(e,t)}pushContentListToExchange(e,...n){for(let t of n)this.exchangeCollectionHandle.getQueueNameList(e,t).then(s=>{for(let u of s)this.pushContentListToQueue(u,t)})}pushContentListToQueue(e,...n){for(let t of n)this.queueCollectionHandle.pushContentToQueue(e,t)}subscribeQueue(e,n,t){this.queueCollectionHandle.subscribeQueue(e,n,t)}unsubscribeQueue(e,n){this.queueCollectionHandle.unsubscribeQueue(e,n)}};function L(o,e){return new d(o,e)}var d=class extends y{constructor(n,t){super(n,t);this.installedPlugins=new Set}use(n,...t){return this.installedPlugins.has(n)?console.log("Plugin has already been applied to target unmq."):n&&h(n.install)?(this.installedPlugins.add(n),n.install(this,...t)):h(n)&&(this.installedPlugins.add(n),n(this,...t)),this}emit(n,...t){return super.pushContentListToExchange(n,...t),this}emitToQueue(n,...t){return super.pushContentListToQueue(n,...t),this}on(n,t,s){return super.subscribeQueue(n,t,s),()=>this.off(n,t)}off(n,t){return super.unsubscribeQueue(n,t),this}once(n,t,s){if(t===void 0)return new Promise(u=>{let r=a=>(this.off(n,r),u(a),!0);this.on(n,r,s)});{let u=(r,a,l)=>(this.off(n,u),t(r,a,l));return this.on(n,u,s),this}}};function P(o,e){return new p(o,e)}var p=class{constructor(e,n){this.exchange=e;this.queueCollection=n;for(let t in n)n[t].name=t}emit(...e){for(let n of e)this.exchange.getQueueNameList(n).then(t=>{for(let s of t)this.queueCollection[s]!==void 0&&this.queueCollection[s].pushContent(n)});return this}emitToQueue(e,...n){for(let t of n)this.queueCollection[e].pushContent(t);return this}on(e,n,t){return this.queueCollection[e].pushConsume(n,t),()=>this.off(e,n)}off(e,n){return h(n)?this.queueCollection[e].removeConsumer(n):this.queueCollection[e].removeAllConsumer(),this}once(e,n,t){if(n===void 0)return new Promise(s=>{let u=r=>(this.off(e,u),s(r),!0);this.on(e,u,t)});{let s=(u,r,a)=>(this.off(e,s),n(u,r,a));return this.on(e,s,t),this}}};var F=d;var A=Object.assign,v=Object.prototype.toString,T=o=>v.call(o),j=Array.isArray,O=o=>T(o)==="[object Map]",U=o=>T(o)==="[object Set]",B=o=>o instanceof Date,h=o=>typeof o=="function",$=o=>typeof o=="string",z=o=>typeof o=="number",J=o=>typeof o=="boolean",K=o=>typeof o=="symbol",N=o=>o!==null&&typeof o=="object",b=o=>N(o)&&h(o.then)&&h(o.catch);0&&(module.exports={ConsumMode,Consumer,Exchange,Logs,News,Queue,QuickUNodeMQ,createQuickUnmq,createUnmq,extend,isArray,isBoolean,isDate,isFunction,isMap,isNumber,isObject,isPromise,isSet,isString,isSymbol,objectToString,toTypeString});
//# sourceMappingURL=index.node.min.js.map
