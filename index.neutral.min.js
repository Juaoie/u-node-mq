var w=(s,e,n)=>new Promise((t,o)=>{var i=r=>{try{c(n.next(r))}catch(f){o(f)}},l=r=>{try{c(n.throw(r))}catch(f){o(f)}},c=r=>r.done?t(r.value):Promise.resolve(r.value).then(i,l);c((n=n.apply(s,e)).next())});var a=class{static random(){return String(Math.round(Math.random()*1e10))}static getTimeFormat(e){let n=null;e?n=new Date(e):n=new Date;let t=n.getFullYear(),o=n.getMonth()+1,i=n.getDate(),l=n.getHours(),c=n.getMinutes(),r=t+"-";return o<10&&(r+="0"),r+=o+"-",i<10&&(r+="0"),r+=i+" ",l<10&&(r+="0"),r+=l+":",c<10&&(r+="0"),r+=c,r}};a.promiseSetTimeout=(e=0)=>new Promise(n=>setTimeout(n,e)),a.memorySize=e=>{let n=0,t;for(let o=0;o<e.length;o++)t=e.charCodeAt(o),t<127?n++:128<=t&&t<=2047?n+=2:2048<=t&&t<=65535?n+=3:n+=4;return n>=1024*1024?(n/(1024*1024)).toFixed(2)+"MB":n>=1024&&n<1024*1024?(n/1024).toFixed(2)+"KB":n+"B"};var u=class{static error(e){console.error(e)}static log(e){console.log(e)}};u.unmq=null;var Q=class{constructor(e){this.id=a.random();this.routes=[];this.repeater=()=>this.getRoutes();(e==null?void 0:e.routes)!==void 0&&(this.routes=e.routes),(e==null?void 0:e.repeater)!==void 0&&(this.repeater=e.repeater),(e==null?void 0:e.name)!==void 0&&(this.name=e.name)}getId(){return this.id}getRoutes(){return this.routes}pushRoutes(e){this.routes=Array.from(new Set(this.routes.concat(e)))}setRoutes(e){this.routes=e}getRepeater(){return this.repeater}setRepeater(e){this.repeater=e}removeRoutes(e){e===void 0?this.routes=[]:this.routes=this.routes.filter(n=>e.indexOf(n)!==-1)}getQueueNameList(e){return w(this,null,function*(){try{return yield this.repeater(e)}catch(n){return u.error("exchange function getstringList exception"),[]}})}};var h=class{constructor(e){this.id=a.random();this.consumedTimes=-1;this.createTime=new Date().getTime(),this.content=e}getId(){return this.id}};var m=class{constructor(e,n){this.id=a.random();this.createTime=new Date().getTime(),this.consume=e,this.payload=n}getId(){return this.id}consumption(e,n){return{then:o=>{try{if(!n)return this.consume(e.content,this.payload),o(!0);let i=(c=!0)=>o(c),l=this.consume(e.content,i,this.payload);k(l)?l.then(c=>{o(Boolean(c))}).catch(()=>{o(!1)}):typeof l=="boolean"&&(i=()=>{},o(l))}catch(i){u.error("Consumer consumption error"),o(!1)}}}}};var b=(n=>(n.Random="Random",n.All="All",n))(b||{}),y=class{constructor(e){this.id=a.random();this.ask=!1;this.rcn=3;this.mode="Random";this.news=[];this.consumerList=[];(e==null?void 0:e.ask)!==void 0&&(this.ask=e.ask),(e==null?void 0:e.news)!==void 0&&(this.news=e.news),(e==null?void 0:e.consumerList)!==void 0&&(this.consumerList=e.consumerList),(e==null?void 0:e.rcn)!==void 0&&(this.rcn=e.rcn),(e==null?void 0:e.mode)!==void 0&&(this.mode=e.mode),(e==null?void 0:e.name)!==void 0&&(this.name=e.name)}getId(){return this.id}getNews(){return this.news}getConsumerList(){return this.consumerList}removeConsumer(e){let n=this.consumerList.findIndex(t=>t.consume===e);return n===-1?!1:(this.consumerList.splice(n,1),!0)}removeAllConsumer(){return this.consumerList=[],!0}removeAllNews(){return this.news=[],!0}removeConsumerById(e){let n=this.consumerList.findIndex(t=>t.getId()===e);return n===-1?!1:(this.consumerList.splice(n,1),!0)}pushConsumer(e){this.consumerList.findIndex(n=>n.getId()===e.getId())===-1&&this.consumerList.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushConsume(e,n){let t=new m(e,n);this.pushConsumer(t)}pushNews(e){e.consumedTimes===-1&&(e.consumedTimes=this.rcn),e.consumedTimes>0&&this.news.findIndex(n=>n.getId()===e.getId())===-1&&this.news.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushContent(e){let n=new h(e);this.pushNews(n)}eject(){return this.news.length>0?this.news.splice(0,1)[0]:null}consumeNews(){if(this.news.length===0||this.consumerList.length===0)return;let e=this.eject();if(e!==null){if(this.mode==="Random"){let n=Math.round(Math.random()*(this.consumerList.length-1)),t=this.consumerList[n];this.consumption(e,t)}else if(this.mode==="All")for(let n of this.consumerList)this.consumption(e,n)}}consumption(e,n){n.consumption(e,this.ask).then(t=>{t?u.log("\u961F\u5217 \u6D88\u8D39\u6210\u529F"):(u.log("\u961F\u5217 \u6D88\u8D39\u5931\u8D25"),e.consumedTimes--,this.pushNews(e)),this.news.length>0&&this.consumeNews()})}};var g=class{constructor(){this.exchangeCollection=new Map}has(e){return this.exchangeCollection.has(e)?!0:(u.error(`${e} not find`),!1)}setExchangeCollection(e){this.exchangeCollection=new Map(Object.entries(e))}getExchange(e){let n=this.exchangeCollection.get(e);if(n===void 0)throw`${e} not find`;return n}getExchangeList(){return[...this.exchangeCollection.values()]}getQueueNameList(e,n){return this.getExchange(e).getQueueNameList(n)}};var x=class{constructor(){this.queueCollection=new Map}has(e){return this.queueCollection.has(e)?!0:(u.error(`${e} not find`),!1)}setQueueCollection(e){this.queueCollection=new Map(Object.entries(e))}getQueue(e){let n=this.queueCollection.get(e);if(n===void 0)throw u.error(`${e} not find`),`${e} not find`;return n}getQueueList(){return[...this.queueCollection.values()]}addQueue(e){if(e.name===void 0)throw"queue.name is undefined";this.queueCollection.set(e.name,e)}pushNewsToQueue(e,n){this.getQueue(e).pushNews(n)}pushContentToQueue(e,n){this.getQueue(e).pushContent(n)}subscribeQueue(e,n,t){this.getQueue(e).pushConsume(n,t)}unsubscribeQueue(e,n){if(!!this.has(e))return n===void 0?this.getQueue(e).removeAllConsumer():this.getQueue(e).removeConsumer(n)}};var p=class{constructor(e,n){this.exchangeCollectionHandle=new g;this.queueCollectionHandle=new x;for(let t in e)e[t].name=t;for(let t in n)n[t].name=t;this.exchangeCollectionHandle.setExchangeCollection(e),this.queueCollectionHandle.setQueueCollection(n)}getExchange(e){return this.exchangeCollectionHandle.getExchange(e)}getExchangeList(){return this.exchangeCollectionHandle.getExchangeList()}getQueue(e){return this.queueCollectionHandle.getQueue(e)}getQueueList(){return this.queueCollectionHandle.getQueueList()}addQueue(e){this.queueCollectionHandle.addQueue(e)}pushNewsListToExchange(e,...n){for(let t of n)this.exchangeCollectionHandle.getQueueNameList(e,t.content).then(o=>{for(let i in o)this.pushNewsListToQueue(i,t)})}pushNewsListToQueue(e,...n){for(let t of n)this.queueCollectionHandle.pushNewsToQueue(e,t)}pushContentListToExchange(e,...n){for(let t of n)this.exchangeCollectionHandle.getQueueNameList(e,t).then(o=>{for(let i of o)this.pushContentListToQueue(i,t)})}pushContentListToQueue(e,...n){for(let t of n)this.queueCollectionHandle.pushContentToQueue(e,t)}subscribeQueue(e,n,t){this.queueCollectionHandle.subscribeQueue(e,n,t)}unsubscribeQueue(e,n){this.queueCollectionHandle.unsubscribeQueue(e,n)}};function L(s,e){return new d(s,e)}var d=class extends p{constructor(n,t){super(n,t);this.installedPlugins=new Set}use(n,...t){return this.installedPlugins.has(n)?console.log("Plugin has already been applied to target unmq."):n&&C(n.install)?(this.installedPlugins.add(n),n.install(this,...t)):C(n)&&(this.installedPlugins.add(n),n(this,...t)),this}emit(n,...t){return super.pushContentListToExchange(n,...t),this}emitToQueue(n,...t){return super.pushContentListToQueue(n,...t),this}on(n,t,o){return super.subscribeQueue(n,t,o),()=>this.off(n,t)}off(n,t){return super.unsubscribeQueue(n,t),this}once(n,t,o){let i=0,l=(c,r,f)=>{if(i!==1)return i++,this.off(n,l),t(c,r,f)};return this.on(n,l,o),this}};var me=d;var de=Object.assign,E=Object.prototype.toString,D=s=>E.call(s),fe=Array.isArray,ge=s=>D(s)==="[object Map]",xe=s=>D(s)==="[object Set]",pe=s=>s instanceof Date,C=s=>typeof s=="function",Ce=s=>typeof s=="string",Qe=s=>typeof s=="number",ye=s=>typeof s=="boolean",we=s=>typeof s=="symbol",T=s=>s!==null&&typeof s=="object",k=s=>T(s)&&C(s.then)&&C(s.catch);export{b as ConsumMode,m as Consumer,Q as Exchange,u as Logs,h as News,y as Queue,L as createUnmq,me as default,de as extend,fe as isArray,ye as isBoolean,pe as isDate,C as isFunction,ge as isMap,Qe as isNumber,T as isObject,k as isPromise,xe as isSet,Ce as isString,we as isSymbol,E as objectToString,D as toTypeString};
