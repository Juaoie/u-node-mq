import{isObject as h,isString as d,Queue as m}from"../../index.js";import{getOtherAllIframeDoc as f}from"./loader.js";export var MessageType=(s=>(s[s.GeneralMessage=0]="GeneralMessage",s[s.FindExchangeMessage=1]="FindExchangeMessage",s[s.SendCoordinateMessage=2]="SendCoordinateMessage",s[s.OnlineNotificationMessage=3]="OnlineNotificationMessage",s))(MessageType||{});export const getInternalIframeMessageQueueName=r=>r+"_Message",getInternalIframeBroadcasMessageQueueName=r=>r+"_Wait_Message";export default class M{constructor(e){this.name=e}install(e,...n){if(!e.getExchange(this.name))throw`${this.name}\u4EA4\u6362\u673A\u4E0D\u5B58\u5728`;this.unmq=e;const i=e.getExchangeList().filter(a=>a.name!==this.name);for(const a of i)a.setRepeater(null),a.setRoutes([getInternalIframeMessageQueueName(a.name),getInternalIframeBroadcasMessageQueueName(a.name)]),e.addQueue(new m({name:getInternalIframeMessageQueueName(a.name)})),e.addQueue(new m({name:getInternalIframeBroadcasMessageQueueName(a.name)})),e.on(getInternalIframeBroadcasMessageQueueName(a.name),()=>{this.broadcastMessage(1,{exchangeName:a.name,msg:`who is ${this.name}`})});this.broadcastMessage(3,null),window.addEventListener("message",this.receiveMessage.bind(this),!1)}receiveMessage({source:e,data:n,origin:t}){if(!h(n))return;const{mask:s,type:i,message:a,fromName:g}=n;if(s==="u-node-mq-plugin"){if([3,2].indexOf(i)!==-1){const o=this.unmq.getExchange(g);if(!o||d(o.origin)&&o.origin!==t)return;this.unmq.on(getInternalIframeMessageQueueName(g),c=>{this.postMessage(e,0,c,t)})();return}if(i===0)return this.unmq.emit(this.name,a);i===1&&a.exchangeName===this.name&&this.postMessage(e,2,{msg:`my name is ${this.name}`},t)}}postMessage(e,n,t,s,i){e.postMessage({mask:"u-node-mq-plugin",type:n,message:t,fromName:this.name},s,i)}broadcastMessage(e,n){f().forEach(s=>{this.postMessage(s.window,e,n,"*")})}}
