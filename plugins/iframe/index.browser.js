(()=>{var l=class{static random(){return String(Math.round(Math.random()*1e10))}static getTimeFormat(e){let t=null;e?t=new Date(e):t=new Date;let s=t.getFullYear(),n=t.getMonth()+1,i=t.getDate(),r=t.getHours(),c=t.getMinutes(),u=s+"-";return n<10&&(u+="0"),u+=n+"-",i<10&&(u+="0"),u+=i+" ",r<10&&(u+="0"),u+=r+":",c<10&&(u+="0"),u+=c,u}};l.promiseSetTimeout=(e=0)=>new Promise(t=>setTimeout(t,e)),l.memorySize=e=>{let t=0,s;for(let n=0;n<e.length;n++)s=e.charCodeAt(n),s<127?t++:128<=s&&s<=2047?t+=2:2048<=s&&s<=65535?t+=3:t+=4;return t>=1024*1024?(t/(1024*1024)).toFixed(2)+"MB":t>=1024&&t<1024*1024?(t/1024).toFixed(2)+"KB":t+"B"};var a=class{static error(e){console.error(e)}static log(e){console.log(e)}};a.unmq=null;var m=class{constructor(e){this.id=l.random();this.consumedTimes=-1;this.createTime=new Date().getTime(),this.content=e}getId(){return this.id}};var g=class{constructor(e,t){this.id=l.random();this.createTime=new Date().getTime(),this.consume=e,this.payload=t}getId(){return this.id}consumption(e,t){return{then:n=>{try{if(!t)return this.consume(e.content,null,this.payload),n(!0);let i=(c=!0)=>n(c),r=this.consume(e.content,i,this.payload);Q(r)?r.then(c=>{n(Boolean(c))}).catch(()=>{n(!1)}):typeof r=="boolean"&&(i=()=>{},n(r))}catch(i){a.error("Consumer consumption error"),n(!1)}}}}};var h=class{constructor(e){this.id=l.random();this.ask=!1;this.rcn=3;this.mode="Random";this.news=[];this.consumerList=[];(e==null?void 0:e.ask)!==void 0&&(this.ask=e.ask),(e==null?void 0:e.news)!==void 0&&(this.news=e.news),(e==null?void 0:e.consumerList)!==void 0&&(this.consumerList=e.consumerList),(e==null?void 0:e.rcn)!==void 0&&(this.rcn=e.rcn),(e==null?void 0:e.mode)!==void 0&&(this.mode=e.mode),(e==null?void 0:e.name)!==void 0&&(this.name=e.name)}getId(){return this.id}getNews(){return this.news}getConsumerList(){return this.consumerList}removeConsumer(e){let t=this.consumerList.findIndex(s=>s.consume===e);return t===-1?!1:(this.consumerList.splice(t,1),!0)}removeAllConsumer(){return this.consumerList=[],!0}removeAllNews(){return this.news=[],!0}removeConsumerById(e){let t=this.consumerList.findIndex(s=>s.getId()===e);return t===-1?!1:(this.consumerList.splice(t,1),!0)}pushConsumer(e){this.consumerList.findIndex(t=>t.getId()===e.getId())===-1&&this.consumerList.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushConsume(e,t){let s=new g(e,t);this.pushConsumer(s)}pushNews(e){e.consumedTimes===-1&&(e.consumedTimes=this.rcn),e.consumedTimes>0&&this.news.findIndex(t=>t.getId()===e.getId())===-1&&this.news.push(e),this.news.length>0&&this.consumerList.length>0&&this.consumeNews()}pushContent(e){let t=new m(e);this.pushNews(t)}eject(){if(this.news.length>0)return this.news.splice(0,1)[0]}consumeNews(){if(this.news.length===0||this.consumerList.length===0)return;let e=this.eject();if(e!==null){if(this.mode==="Random"){let t=Math.round(Math.random()*(this.consumerList.length-1)),s=this.consumerList[t];this.consumption(e,s)}else if(this.mode==="All")for(let t of this.consumerList)this.consumption(e,t)}}consumption(e,t){t.consumption(e,this.ask).then(s=>{s?a.log("\u961F\u5217 \u6D88\u8D39\u6210\u529F"):(a.log("\u961F\u5217 \u6D88\u8D39\u5931\u8D25"),e.consumedTimes--,this.pushNews(e)),this.news.length>0&&this.consumeNews()})}};var pe=Array.isArray;var f=o=>typeof o=="function",w=o=>typeof o=="string";var d=o=>o!==null&&typeof o=="object",Q=o=>d(o)&&f(o.then)&&f(o.catch);function y(){return b(window.top,0,0).filter(e=>e.window!==window.self)}function b(o,e,t){let s=[];s.push({window:o,x:e,y:t}),t+=1;for(let n=0;n<o.length;n++)s.push(...b(o[n],e,t)),e+=1;return s}var k=(n=>(n[n.GeneralMessage=0]="GeneralMessage",n[n.FindExchangeMessage=1]="FindExchangeMessage",n[n.SendCoordinateMessage=2]="SendCoordinateMessage",n[n.OnlineNotificationMessage=3]="OnlineNotificationMessage",n))(k||{}),p=o=>o+"_Iframe_Message",x=o=>o+"_Iframe_Wait_Message",C=class{constructor(e){this.name=e}install(e,...t){if(!e.getExchange(this.name))throw`${this.name}\u4EA4\u6362\u673A\u4E0D\u5B58\u5728`;this.unmq=e;let i=e.getExchangeList().filter(r=>r.name!==this.name);for(let r of i)r.setRepeater(null),r.setRoutes([p(r.name),x(r.name)]),e.addQueue(new h({name:p(r.name)})),e.addQueue(new h({name:x(r.name)})),e.on(x(r.name),()=>{this.broadcastMessage(1,{exchangeName:r.name,msg:`who is ${this.name}`})});this.broadcastMessage(3,null),window.addEventListener("message",this.receiveMessage.bind(this),!1)}receiveMessage({source:e,data:t,origin:s}){if(!d(t))return;let{mask:n,type:i,message:r,fromName:c}=t;if(n==="u-node-mq-plugin"){if([3,2].indexOf(i)!==-1){let u=this.unmq.getExchange(c);if(!u||w(u.origin)&&u.origin!==s)return;this.unmq.on(p(c),E=>{this.postMessage(e,0,E,s)})();return}if(i===0)return this.unmq.emit(this.name,r);i===1&&r.exchangeName===this.name&&this.postMessage(e,2,{msg:`my name is ${this.name}`},s)}}postMessage(e,t,s,n,i){e.postMessage({mask:"u-node-mq-plugin",type:t,message:s,fromName:this.name},n,i)}broadcastMessage(e,t){y().forEach(n=>{this.postMessage(n.window,e,t,"*")})}};})();
